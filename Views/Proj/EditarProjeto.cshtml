@model Itau.PO.UI.MVC.ViewModel.ProjetoViewModel

@{
    ViewBag.Title = "Editar Projeto";
}

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section css{
    <link href="~/Content/assets/apps/css/todo-2.min.css" rel="stylesheet" />
    <link href="~/Content/assets/plugins/switchery/dist/switchery.min.css" rel="stylesheet" />
    <link href="~/Content/assets/plugins/bootstrap-datepicker/bootstrap-datepicker.min.css" rel="stylesheet" type="text/css" />

    <style>
        .form-body .col-md-12 ul,
        .form-group .col-md-12 form ul {
            padding-left: 0px;
            list-style: none;
        }

            .form-body .col-md-12 ul li,
            .form-group .col-md-12 form ul li {
                display: flex;
            }

                .form-body .col-md-12 ul li a,
                .form-group .col-md-12 form ul li a {
                    padding-right: 10px;
                }

        .form-body ul,
        .form-group form ul {
            padding-left: 0px;
            list-style: none;
        }

            .form-body ul li,
            .form-group form ul li {
                display: flex;
            }

                .form-body ul li a,
                .form-group form ul li a {
                    padding-right: 10px;
                }

        .text-center label {
            color: #028ee1;
            font-weight: 700;
        }

        .form-group b {
            font-weight: 700;
        }

        #divComentarios ul {
            list-style-type: none;
        }

        /*ScrollStyle*/
        .scrollStyle::-webkit-scrollbar-track {
            -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
            border-radius: 10px;
            background-color: #F5F5F5;
        }

        .scrollStyle::-webkit-scrollbar {
            width: 8px;
            height: 8px;
            background-color: #F5F5F5;
        }

        .scrollStyle::-webkit-scrollbar-thumb {
            border-radius: 10px;
            -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,.3);
            /*background-color: #555;*/
        }
        /*ScrollStyle*/

        .divVerde {
            background-color: forestgreen;
        }

        .divAmarela {
            background-color: #FFF333;
        }

        .divVermelha {
            background-color: red;
        }

        .textoBranco {
            color: white;
        }

        /*.textoBranco label, .textoBranco b {
            font-size: 20px;
        }*/
    </style>
}

<style>
    .timeline > li > .timeline-panel:after {
        content: none;
    }

    /*[type=checkbox]:checked, [type=checkbox]:not(:checked) {
        position: relative !important;
        left: 0px !important;
        opacity: 1 !important;
    }*/

    .timeline,
    .timeline-horizontal {
        list-style: none;
        padding: 20px;
        position: relative;
    }

        .timeline:before {
            top: 40px;
            bottom: 0;
            position: absolute;
            content: " ";
            width: 3px;
            background-color: #eeeeee;
            left: 50%;
            margin-left: -1.5px;
        }

        .timeline .timeline-item {
            margin-bottom: 20px;
            position: relative;
        }

            .timeline .timeline-item:before,
            .timeline .timeline-item:after {
                content: "";
                display: table;
            }

            .timeline .timeline-item:after {
                clear: both;
            }

            .timeline .timeline-item .timeline-badge {
                color: #fff;
                width: 45px;
                height: 45px;
                line-height: 52px;
                font-size: 22px;
                text-align: center;
                position: absolute;
                top: 18px;
                left: 50%;
                margin-left: -25px;
                background-color: #7c7c7c;
                border: 3px solid #ffffff;
                z-index: 10;
                border-top-right-radius: 50%;
                border-top-left-radius: 50%;
                border-bottom-right-radius: 50%;
                border-bottom-left-radius: 50%;
            }

                .timeline .timeline-item .timeline-badge i,
                .timeline .timeline-item .timeline-badge .fa,
                .timeline .timeline-item .timeline-badge .glyphicon {
                    top: 2px;
                    left: 0px;
                }

                .timeline .timeline-item .timeline-badge.primary {
                    /*background-color: #1f9eba;*/
                    background-color: forestgreen;
                }

                .timeline .timeline-item .timeline-badge.info {
                    background-color: #5bc0de;
                }

                .timeline .timeline-item .timeline-badge.success {
                    background-color: #59ba1f;
                }

                .timeline .timeline-item .timeline-badge.warning {
                    background-color: #d1bd10;
                }

                .timeline .timeline-item .timeline-badge.danger {
                    background-color: #ba1f1f;
                }

            .timeline .timeline-item .timeline-panel {
                position: relative;
                width: 46%;
                float: left;
                right: 16px;
                border: 1px solid #c0c0c0;
                background: #ffffff;
                border-radius: 2px;
                padding: 20px;
                -webkit-box-shadow: 0 1px 6px rgba(0, 0, 0, 0.175);
                box-shadow: 0 1px 6px rgba(0, 0, 0, 0.175);
            }

                .timeline .timeline-item .timeline-panel:before {
                    position: absolute;
                    top: 26px;
                    right: -16px;
                    display: inline-block;
                    border-top: 16px solid transparent;
                    border-left: 16px solid #c0c0c0;
                    border-right: 0 solid #c0c0c0;
                    border-bottom: 16px solid transparent;
                    content: " ";
                }

                .timeline .timeline-item .timeline-panel .timeline-title {
                    margin-top: 0;
                    color: inherit;
                }

                .timeline .timeline-item .timeline-panel .timeline-body > p,
                .timeline .timeline-item .timeline-panel .timeline-body > ul {
                    margin-bottom: 0;
                }

                    .timeline .timeline-item .timeline-panel .timeline-body > p + p {
                        margin-top: 5px;
                    }

            .timeline .timeline-item:last-child:nth-child(even) {
                float: right;
            }

            .timeline .timeline-item:nth-child(even) .timeline-panel {
                float: right;
                left: 16px;
            }

                .timeline .timeline-item:nth-child(even) .timeline-panel:before {
                    border-left-width: 0;
                    border-right-width: 14px;
                    left: -14px;
                    right: auto;
                }

    .timeline-horizontal {
        list-style: none;
        position: relative;
        padding: 30px 0px 20px 0px;
        display: inline-block;
    }

        .timeline-horizontal:before {
            height: 3px;
            top: auto !important;
            bottom: 26px;
            left: 30px !important;
            right: 0 !important;
            width: 115% !important;
            margin-bottom: 20px;
            position: absolute;
        }

        .timeline-horizontal .timeline-item {
            display: table-cell;
            height: 180px;
            width: 100%;
            min-width: 100px;
            float: none !important;
            padding-left: 00px;
            padding-right: 20px;
            margin: 0 auto;
            vertical-align: bottom;
        }

            .timeline-horizontal .timeline-item .timeline-panel {
                top: auto !important;
                bottom: 50px;
                display: inline-block;
                float: none !important;
                left: 0 !important;
                right: 0 !important;
                width: 110%;
                margin-bottom: 10px;
            }

                .timeline-horizontal .timeline-item .timeline-panel:before {
                    top: auto !important;
                    bottom: -16px;
                    left: 20px !important;
                    right: auto;
                    border-right: 18px solid transparent !important;
                    border-top: 16px solid #c0c0c0 !important;
                    border-bottom: 0 solid #c0c0c0 !important;
                    border-left: 16px solid transparent !important;
                }

            .timeline-horizontal .timeline-item:before,
            .timeline-horizontal .timeline-item:after {
                display: none;
            }

            .timeline-horizontal .timeline-item .timeline-badge {
                top: auto !important;
                bottom: 0px;
                left: 43px;
            }

    ul.timeline > li > .timeline-panel {
        float: left;
        position: relative;
        width: 20%;
    }

    ::-webkit-scrollbar-track {
        background-color: #F4F4F4;
    }

    ::-webkit-scrollbar {
        width: 6px;
        background: #F4F4F4;
    }

    ::-webkit-scrollbar-thumb {
        background: #dad7d7;
    }
</style>


<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="scrollStyle" style="display:inline-block;width:100%;overflow-y:auto;">
                        <ul class="timeline timeline-horizontal">
                            <li class="timeline-item">
                                <div class="timeline-badge primary"><i class="fa fa-check" style="position: relative; top: -7px"></i></div>
                                <div class="timeline-panel">
                                    <div class="timeline-body">
                                        <p align="center">Cadastro de Projeto</p>
                                        <p align="center">10/01/2019</p>
                                    </div>
                                </div>
                            </li>
                            <li class="timeline-item">
                                <div class="timeline-badge primary"><i class="fa fa-check" style="position: relative; top: -7px"></i></div>
                                <div class="timeline-panel">
                                    <div class="timeline-body">
                                        <p align="center">Priorização</p>
                                        <p align="center">25/02/2019</p>
                                    </div>
                                </div>
                            </li>
                            <li class="timeline-item">
                                <div class="timeline-badge primary"><i class="fa fa-check" style="position: relative; top: -7px"></i></div>
                                <div class="timeline-panel">
                                    <div class="timeline-body">
                                        <p align="center">Específicação</p>
                                        <p align="center">01/03/2019</p>
                                    </div>
                                </div>
                            </li>
                            <li class="timeline-item">
                                <div class="timeline-badge primary"><i class="fa fa-check" style="position: relative; top: -7px"></i></div>
                                <div class="timeline-panel">
                                    <div class="timeline-body">
                                        <p align="center">Priorização</p>
                                        <p align="center">25/02/2019</p>
                                    </div>
                                </div>
                            </li>
                            <li class="timeline-item">
                                <div class="timeline-badge primary"><i class="fa fa-check" style="position: relative; top: -7px"></i></div>
                                <div class="timeline-panel">
                                    <div class="timeline-body">
                                        <p align="center">Parecer do Arquiteto Especificação</p>
                                        <p align="center">25/02/2019</p>
                                    </div>
                                </div>
                            </li>
                            <li class="timeline-item">
                                <div class="timeline-badge primary"><i class="fa fa-check" style="position: relative; top: -7px"></i></div>
                                <div class="timeline-panel">
                                    <div class="timeline-body">
                                        <p align="center">Estomativa do Desenvolvimento</p>
                                        <p align="center">20/5/2019</p>
                                    </div>
                                </div>
                            </li>
                            <li class="timeline-item float-left">
                                <div class="timeline-badge primary"><i class="glyphicon glyphicon-check"></i></div>
                                <div class="timeline-panel">
                                    <div class="timeline-body">
                                        <p align="center">Parecer do Arquiteto Estimativa</p>
                                        <p align="center">25/02/2019</p>
                                    </div>
                                </div>
                            </li>
                            <li class="timeline-item">
                                <div class="timeline-badge primary"><i class="glyphicon glyphicon-check"></i></div>
                                <div class="timeline-panel">
                                    <div class="timeline-body">
                                        <p align="center">Desenvolvimento</p>
                                        <p align="center">25/02/2019</p>
                                    </div>
                                </div>
                            </li>
                            <li class="timeline-item">
                                <div class="timeline-badge primary"><i class="glyphicon glyphicon-check"></i></div>
                                <div class="timeline-panel">
                                    <div class="timeline-body">
                                        <p align="center">Homologação</p>
                                        <p align="center">25/02/2019</p>
                                    </div>
                                </div>
                            </li>
                            <li class="timeline-item">
                                <div class="timeline-badge primary"><i class="glyphicon glyphicon-check"></i></div>
                                <div class="timeline-panel">
                                    <div class="timeline-body">
                                        <p align="center">Implantação</p>
                                        <p align="center">25/02/2019</p>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-9">
            @Html.Partial("Editar/_partialEspecificacao", Model)
        </div>
        <div class="col-3">
            @*MUDAR AQUI AS CORES DO CARD-BODY PARA divVerde, divAmarela, divVermelha*@
            @*SE COLOCAR A divAmarela, deve-se retirar a classe "textoBranco" da tag h4 e da div "<div class="form-group textoBranco">"*@
            <div class="card divVerde">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="text-center">
                                <h4 class="card-title textoBranco">Conclusão do Projeto:</h4>
                                <label style="font-size: 80px">100%</label>
                            </div>

                            <div class="form-group textoBranco">
                                @Html.LabelFor(model => model.CustoHoras, htmlAttributes: new { @class = "control-label" })
                                <b>@Model.CustoHoras</b>
                                <br />
                                <label>% Percentual: <b>85%</b></label>
                                <br />
                                @Html.LabelFor(model => model.HorasTrabalhadas, htmlAttributes: new { @class = "control-label" })
                                <b>@Model.HorasTrabalhadas</b>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-9">
            @*@Html.Partial("Editar/_partialRisco", new { IdProjeto = Model.IdProjeto })*@
            @*@Html.Action("ComentariosRisco", "Proj", new { IdProjeto = Model.IdProjeto })*@
            @Html.Action("ComentariosRisco", "Proj", Model)
        </div>

        <div class="col-3">
            @*@Html.Partial("Editar/_partialHorasTrabalhadas", new Itau.PO.UI.MVC.ViewModel.ProjetoHorasTrabalhadasViewModel() { IdProjeto = Model.IdProjeto, DataTrabalhada = DateTime.Now })*@

            @Html.Action("HorasTrabalhadas", "Proj", new { IdProjeto = Model.IdProjeto })
        </div>
    </div>

    <div class="row">
        <div class="col-9">
            @Html.Partial("Editar/_partialPrioridade", Model)
        </div>

        <div class="col-3">
            @Html.Partial("Editar/_partialCusto", Model)
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            @Html.Partial("Editar/_partialOutrasInformacoes", Model)
        </div>
    </div>
</div>

@section scripts{
    @*<script src="~/Content/assets/apps/scripts/todo-2.min.js"></script>*@
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="~/Content/assets/plugins/switchery/dist/switchery.min.js"></script>
    @*<script src="~/Content/assets/plugins/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>*@

    <script src="~/Scripts/jquery.unobtrusive-ajax.js"></script>
    <script src="~/Scripts/jquery.validate.min.js"></script>

    <script>
        $(document).ready(function () {
            $('.js-switch').each(function () {
                new Switchery($(this)[0], $(this).data());
            });

            var changeCheckbox = document.querySelector('#chkFluxoPaliativo');

            changeCheckbox.onchange = function () {
                if (changeCheckbox.checked) {
                    $("#divFileUploadFluxoPaliativo").css("display", "block");
                    //$("#lblFileUploadFluxoPaliativo").hide();
                } else {
                    $("#divFileUploadFluxoPaliativo").css("display", "none");
                }
            };

            $(function () { // will trigger when the document is ready
                ////$('.datepicker').datepicker(); //Initialise any date pickers
                ////$("input[type='date']").datepicker();
                //$("#name").datepicker();
            });

            $("#chkFluxoPaliativo").change();

            //lblFileUploadFluxoPaliativo

            verifyCheckAll("checkUser", "checkAllUser");

            $(".checkUser").click(function () {
                if ($(this).is(":checked")) {
                    verifyCheckAll("checkUser", "checkAllUser");
                }
                else {
                    $("#checkAllUser").prop("checked", false);
                }

                ListaDesenvolvedores();
            });

            $("#checkAllUser").click(function () {
                $('.checkUser').not(this).prop('checked', this.checked);

                ListaDesenvolvedores();
            });
        });

        function verifyCheckAll(nameClassItem, objCheckAll) {
            var isAllChecked = 0;
            $("." + nameClassItem.replace(".", "")).each(function () {
                if (!this.checked)
                    isAllChecked = 1;
            })
            if (isAllChecked == 0) {
                $("#" + objCheckAll.replace("#", "")).prop("checked", true);
            }
        }

        function ValidarCamposEspecificacao() {
            var bValido = true;

            if ($("#NomeProjeto").val().trim() == "") {
                $("#erroSpanNomeProjeto").css("display", "block");
                bValido = false;
            }
            else {
                $("#erroSpanNomeProjeto").css("display", "none");
            }

            if ($("#DataInicio").val().trim() == "") {
                $("#erroSpanDataInicio").css("display", "block");
                bValido = false;
            }
            else {
                $("#erroSpanDataInicio").css("display", "none");
            }

            if ($("#IdRisco").val() == "0") {
                $("#erroSpanRisco").css("display", "block");
                bValido = false;
            }
            else {
                $("#erroSpanRisco").css("display", "none");
            }

            if ($("#IdUsuarioAnalista").val() == "0") {
                $("#erroSpanAnalista").css("display", "block");
                bValido = false;
            }
            else {
                $("#erroSpanAnalista").css("display", "none");
            }

            if ($("#IdProjetoStatus").val() == "0") {
                $("#erroSpanProjetoStatus").css("display", "block");
                bValido = false;
            }
            else {
                $("#erroSpanProjetoStatus").css("display", "none");
            }

            var iCountSelecionado = 0;

            $(".checkUser").each(function () {
                if ($(this)[0].checked) {
                    iCountSelecionado++;
                }
            });

            if (iCountSelecionado == 0) {
                $("#erroSpanDesenvolvedor").css("display", "block");
                bValido = false;
            }
            else {
                $("#erroSpanDesenvolvedor").css("display", "none");
            }

            if ($("#IdUsuarioDesenvolvedor").val() == "0") {
                $("#erroSpanUsuarioLider").css("display", "block");
                bValido = false;
            }
            else {
                $("#erroSpanUsuarioLider").css("display", "none");
            }

            return bValido;
        }

        function ValidarCamposHorasTrabalhadas() {
            var bValido = true;

            //https://docs.microsoft.com/en-us/dotnet/api/system.data.sqltypes.sqldatetime.minvalue?view=netframework-4.8
            //Remarks
            //The minimum valid date for a SqlDateTime structure is January 1, 1753.
            if ($("#DataTrabalhada").val().trim() == "" || $("#DataTrabalhada").val().trim() == "0001-01-01") {
                $("#erroSpanDataTrabalhada").html("O campo Data Trabalhada é obrigatório.");
                $("#erroSpanDataTrabalhada").css("display", "block");
                bValido = false;
            }
            else {
                var arrayData = $("#DataTrabalhada").val().trim().split("-");
                var data = new Date(arrayData[0] + "/" + arrayData[1] + "/" + arrayData[2]);
                var dataMin = new Date("1753/01/01");

                var dataAtualSemFormat = new Date($.now());
                var dataAtualAno = dataAtualSemFormat.getFullYear();
                var dataAtualMes = dataAtualSemFormat.getMonth() + 1; //getMonth() is zero-based
                var dataAtualDia = dataAtualSemFormat.getDate();

                var dataMax = new Date(dataAtualAno + "/" + dataAtualMes + "/" + dataAtualDia);

                if (data < dataMin) {
                    $("#erroSpanDataTrabalhada").html("Data deve ser maior ou igual à 01/01/1753.");
                    $("#erroSpanDataTrabalhada").css("display", "block");

                    bValido = false;
                }
                else if (data > dataMax) {
                    $("#erroSpanDataTrabalhada").html("Data deve ser menor ou igual à data atual.");
                    $("#erroSpanDataTrabalhada").css("display", "block");

                    bValido = false;
                }
                else {
                    $("#erroSpanDataTrabalhada").css("display", "none");
                }
            }

            if ($("#MinutosTrabalhados").val().trim() == "" || parseFloat($("#MinutosTrabalhados").val().trim()) == 0) {
                $("#erroSpanMinutosTrabalhados").html("O campo Minutos Trabalhados é obrigatório.");
                $("#erroSpanMinutosTrabalhados").css("display", "block");
                bValido = false;
            }
            else {
                $("#erroSpanMinutosTrabalhados").css("display", "none");
            }

            if (bValido) {
                $.ajax({
                    type: "POST",
                    url: "/Proj/ValidarDataHoraTrabalhada",
                    async: false,
                    contentType: "application/json",
                    data: "{idProjeto: " + $("#IdProjeto").val() + ", data:" + JSON.stringify($("#DataTrabalhada").val().trim()) + "}",
                    dataType: "json",
                    success: function (data) {
                        if (parseInt($("#MinutosTrabalhados").val().trim()) > parseInt(data.maxMinutosLancamento)) {
                            $("#erroSpanMinutosTrabalhados").html("Máximo permitido para esta data: " + data.maxMinutosLancamento);
                            $("#erroSpanMinutosTrabalhados").css("display", "block");
                            bValido = false;
                        }
                        else {
                            $("#erroSpanMinutosTrabalhados").css("display", "none");
                        }
                    },
                    error: function (data) {
                        swal("Erro!", " ", "error");
                        bValido = false;
                    }
                });
            }

            return bValido;
        }

        function ValidarCamposOutrasInformacoes() {
            var bValido = true;

            if ($("#OutrasInformacoes").val().trim() == "") {
                $("#erroSpanOutrasInformacoes").css("display", "block");
                bValido = false;
            }
            else {
                $("#erroSpanOutrasInformacoes").css("display", "none");
            }

            return bValido;
        }

        function ValidarCamposComentarioRisco() {
            var bValido = true;

            if ($("#ComentarioRisco").val().trim() == "") {
                $("#erroSpanComentarioRisco").css("display", "block");
                bValido = false;
            }
            else {
                $("#erroSpanComentarioRisco").css("display", "none");
            }

            return bValido;
        }

        function ValidarCamposPrioridade() {
            var bValido = true;

            if ($("#ComentarioRisco").val().trim() == "") {
                $("#erroSpanComentarioRisco").css("display", "block");
                bValido = false;
            }
            else {
                $("#erroSpanComentarioRisco").css("display", "none");
            }

            return bValido;
        }

        function ListaDesenvolvedores() {
            var projetoViewModel = new FormData($('#form')[0]);

            $.ajax({
                type: "POST",
                url: "/Proj/ListaUsuariosDesenvolvedores",
                async: false,
                data: projetoViewModel,
                contentType: false,
                processData: false,
                success: function (data) {
                    //if (parseFloat($("#HorasTrabalhadas").val().trim()) > parseFloat(data.maxTotal)) {
                    //    $("#erroSpanHorasTrabalhadas").html("Máximo permitido para esta data: " + data.maxTotal);
                    //    $("#erroSpanHorasTrabalhadas").css("display", "block");
                    //    bValido = false;
                    //}
                    //else {
                    //    $("#erroSpanHorasTrabalhadas").css("display", "none");
                    //}

                    $("#IdUsuarioDesenvolvedor").children().remove();
                    for (i = 0; i < data.lstUsuariosLider.length; i++) {
                        $("#IdUsuarioDesenvolvedor").append($('<option>', {
                            value: data.lstUsuariosLider[i].Value,
                            text: data.lstUsuariosLider[i].Text,
                            selected: data.lstUsuariosLider[i].Selected
                        }));
                    }
                },
                error: function (data) {
                    swal("Erro!", " ", "error");
                    bValido = false;
                }
            });
        }

        function OnSuccess(data) {
            swal({
                title: "Salvo!",
                text: "Informações salvas com sucesso!",
                icon: "success",
                buttons: {
                    continuar: {
                        text: "Continuar",
                        value: "continuar",
                    }
                },
            })
                .then(() => {
                    window.location.href = data.redirectUrl;
                });
        }
        function OnFailure(data) {
            swal({
                title: "Erro!",
                text: "Erro ao salvar as informções!",
                icon: "error",
                buttons: {
                    continuar: {
                        text: "Continuar",
                        value: "continuar",
                    }
                },
            });
        }
    </script>
}